# 項目架構

## 概述

mmfm-playback-go 是一個現代化的 Go 項目，採用清潔架構原則，將業務邏輯與基礎設施分離。項目結構遵循 Go 社區的最佳實踐。

## 架構層次

### 1. 表示層 (cmd)

```
cmd/mmfm-playback/main.go
```

- 應用程序入口點
- 解析命令行參數
- 初始化依賴並啟動應用程序
- 不包含業務邏輯

### 2. 業務邏輯層 (internal)

#### 配置模塊 (internal/config)
- 負責加載和驗證應用程序配置
- 支持 JSON 文件和環境變量
- 提供配置驗證和保存功能

#### 播放器模塊 (internal/player)
- 核心播放邏輯
- 管理播放列表和播放狀態
- 處理播放、暫停、下一首等操作
- 與緩存和聊天系統協作

#### 緩存模塊 (internal/cache)
- 音頻文件緩存管理
- 下載和存儲遠程音頻文件
- 清理不需要的緩存文件

#### 聊天模塊 (internal/chat)
- WebSocket 通信處理
- Socket.IO 協議實現
- 消息處理和事件發送

#### 探測模塊 (internal/probe)
- 媒體文件分析
- FFprobe 集成
- 獲取音頻文件元數據

#### 日誌模塊 (internal/logger)
- 統一日誌系統
- 日誌格式化和級別管理

### 3. 共享類型 (pkg/types)
- 定義跨模塊共享的數據結構
- Song 結構體定義
- 通用接口定義

## 設計模式

### 依賴注入
各個組件通過構造函數接收其依賴，而不是直接創建依賴實例。

### 接口抽象
關鍵功能通過接口定義，實現了松耦合和可測試性。

### 單一職責原則
每個包和結構都只負責一個明確的功能領域。

## 包依賴關係

```
cmd/mmfm-playback -> internal/config
cmd/mmfm-playback -> internal/player
internal/player -> internal/cache
internal/player -> internal/chat
internal/player -> internal/config
internal/player -> pkg/types
internal/cache -> pkg/types
internal/chat -> pkg/types
```

## 並發模型

項目採用 Go 的並發模型：

- 使用 goroutines 處理並發操作
- 使用 channels 進行 goroutine 之間的通信
- 在緩存下載和播放狀態跟蹤中使用並發

## 錯誤處理

- 使用 Go 慣用的錯誤處理方式
- 錯誤信息包含上下文信息
- 在關鍵位置記錄錯誤日誌

## 測試策略

### 單元測試
- 為每個包編寫單元測試
- 測試配置加載和驗證
- 驗證邊界條件和錯誤情況

### 集成測試
- 測試組件之間的交互
- 驗證端到端功能

## 部署架構

### 本地部署
- 直接運行二進制文件
- 使用本地配置文件或環境變量

### 容器化部署
- Docker 容器化
- 支持環境變量配置
- 最小化鏡像大小

## 擴展性

### 功能擴展
- 新功能可以作為新的 internal 包添加
- 通過接口擴展現有功能
- 遵循開放封閉原則

### 配置擴展
- 新的配置選項可以輕鬆添加
- 向後兼容性得到保持
- 支持多種配置來源

## 安全性

### 輸入驗證
- 配置值驗證
- 防止路徑遍歷攻擊

### 最小權限
- Docker 容器使用非 root 用戶
- 限制文件系統訪問

## 性能優化

### 緩存策略
- 音頻文件本地緩存
- 智能緩存清理

### 並發優化
- 使用 goroutines 並發下載
- 非阻塞操作

## 維護性

### 代碼組織
- 清晰的包結構
- 一致的命名約定
- 良好的文檔

### 日誌記錄
- 結構化日誌
- 不同日誌級別
- 有用的調試信息