# 測試策略

## 概述

mmfm-playback-go 項目採用全面的測試策略，確保代碼質量和功能正確性。測試策略涵蓋單元測試、集成測試和端到端測試。

## 測試層次

### 1. 單元測試

#### 目標
- 測試單個函數和方法
- 驗證業務邏輯的正確性
- 測試邊界條件和錯誤情況

#### 位置
- 與源代碼在同一目錄下，以 `_test.go` 結尾
- 例如：`internal/config/config_test.go`

#### 測試內容
- 配置加載和驗證
- 錯誤處理路徑
- 環境變量覆蓋
- 數據結構方法

#### 示例測試
```go
func TestNewConfigFromFile(t *testing.T) {
    // 測試從文件加載配置
}

func TestConfigFromEnvironment(t *testing.T) {
    // 測試環境變量覆蓋
}

func TestConfigValidation(t *testing.T) {
    // 測試配置驗證
}
```

### 2. 集成測試

#### 目標
- 測試組件之間的交互
- 驗證系統級功能
- 測試外部依賴集成

#### 位置
- `tests/` 目錄下
- 專門的集成測試文件

#### 測試內容
- 配置與播放器的集成
- 緩存與播放的協作
- 聊天系統與播放狀態的同步

### 3. 端到端測試

#### 目標
- 測試完整的工作流程
- 驗證系統在真實場景下的行為

#### 位置
- `tests/e2e/` 目錄下

## 測試最佳實踐

### 命名約定
- 測試函數名稱應描述被測試的行為
- 使用格式：`Test[FunctionName][Scenario]`
- 例如：`TestConfigFromEnvironment`

### 測試結構
- 使用 "arrange, act, assert" 模式
- 每個測試只測試一個概念
- 提供清晰的失敗消息

### 測試數據
- 使用臨時文件進行文件相關測試
- 在測試結束後清理測試數據
- 避免測試之間的相互依賴

## 測試運行

### 單元測試
```bash
# 運行所有測試
go test ./...

# 運行特定包的測試
go test ./internal/config

# 運行測試並顯示詳細輸出
go test -v ./...

# 運行測試並生成覆蓋率報告
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html
```

### 測試覆蓋率目標
- 最小覆蓋率：80%
- 關鍵業務邏輯：100% 覆蓋率
- 錯誤處理路徑：必須測試

## 測試環境

### 配置測試
- 測試 JSON 配置文件加載
- 測試環境變量覆蓋
- 測試配置驗證和錯誤處理
- 測試配置保存功能

### 緩存測試
- 測試文件緩存邏輯
- 測試緩存清理功能
- 測試並發緩存操作
- 測試錯誤情況處理

### 播放器測試
- 測試播放列表管理
- 測試播放狀態轉換
- 測試錯誤恢復機制

## Mock 和 Stub

### 使用場景
- 模擬外部 API 調用
- 模擬文件系統操作
- 模擬網絡通信

### Mock 策略
- 為接口創建 mock 實現
- 使用接口抽象減少依賴
- 測試不同場景下的行為

## 持續集成

### 測試執行
- 在每次提交時運行單元測試
- 在 PR 合併前運行完整測試套件
- 監控測試覆蓋率

### 測試報告
- 生成測試覆蓋率報告
- 追蹤測試執行時間
- 識別不穩定的測試

## 測試維護

### 測試更新
- 當代碼更改時更新相應測試
- 定期審查和清理過時測試
- 保持測試與代碼同步

### 測試性能
- 優化慢速測試
- 使用並行測試提高效率
- 避免不必要的設置和清理開銷

## 測試覆蓋範圍

### 功能測試
- 配置加載和驗證
- 播放控制功能
- 緩存管理
- 網絡通信

### 邊界條件
- 空配置值
- 無效的 JSON 格式
- 文件系統錯誤
- 網絡連接問題

### 錯誤處理
- 配置文件不存在
- 無效的配置值
- 網絡請求失敗
- 文件權限問題

## 測試工具

### 標準庫
- `testing` 包
- `testify` (如果引入) 用於斷言

### 測試輔助函數
- 用於創建臨時文件和目錄
- 用於設置和清理測試環境
- 用於模擬不同測試場景

## 測試文檔

### 測試說明
- 每個測試都應有清晰的說明
- 解釋測試的目的和場景
- 記錄預期的行為

### 測試維護
- 定期審查測試的有效性
- 更新過時的測試說明
- 刪除不再相關的測試